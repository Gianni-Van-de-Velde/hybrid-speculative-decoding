class HashMapNgram:
    def __init__(self, max_match_length=10, continuation_length=10):
        self.max_match_length = max_match_length
        self.continuation_length = continuation_length
        self.context = []

        self.copy_dict = {i: dict() for i in range(1, max_match_length + 1)}

    def preprocess_prompt(self, input_ids):
        """
        Precomputes k-gram token hashes from the prompt for efficient copy detection.

        Args:
            input_ids (torch.Tensor): Tokenized input prompt.
        """
        prev_len = len(self.context)
        self.context.extend(input_ids)
        
        for k in range(1, self.max_match_length + 1):
            for i in range(max(0, prev_len - k), len(self.context) - k + 1):
                token_group = tuple(self.context[i:i + k])  # Extract k consecutive tokens
                token_hash = hash(token_group)  # Hash the group
                
                # Add the hash to the dictionary, recording the position
                if token_hash not in self.copy_dict[k]:
                    self.copy_dict[k][token_hash] = []
                self.copy_dict[k][token_hash].append(i + k)  # Append the starting position of the group

    def find_text_position(self, input_ids):
        """
        Finds stored positions of a token sequence based on precomputed hashes.

        Args:
            input_ids (tuple): Tokenized sequence to search for.

        Returns:
            list: List of positions where the sequence appears in the stored prompt.
        """
        all_positions = set()
        for k in range(1, self.max_match_length + 1):
            # Hash the tokenized group
            token_hash = hash(tuple(input_ids[-k:]))
            copy_dict_k = self.copy_dict[k]
            if token_hash in copy_dict_k:
                positions = copy_dict_k[token_hash]
                all_positions.update(positions)
        return all_positions
        
if __name__ == "__main__":
    # Example usage
    ngram = HashMapNgram()
    prompt = [128000, 10464, 279, 2768, 9863, 315, 2317, 311, 4320, 279, 3488, 627, 262, 482, 23, 12, 262, 220, 24, 271, 33079, 63347, 29717, 12528, 271, 257, 220, 806, 13, 21, 13, 356, 36119, 34590, 50, 13, 1115, 23314, 1253, 387, 16070, 304, 1403, 477, 810, 38495, 11, 1855, 315, 902, 4985, 387, 25660, 459, 4113, 11, 719, 682, 315, 902, 3871, 4985, 35256, 832, 323, 279, 1890, 14473, 382, 257, 220, 806, 13, 22, 13, 2006, 48904, 4053, 16788, 56740, 78536, 11, 46289, 20398, 6340, 3414, 3651, 21219, 12, 8069, 13, 578, 21931, 56030, 1077, 30255, 1234, 279, 19705, 315, 279, 77956, 8825, 10734, 74465, 488, 323, 11842, 12, 10464, 56875, 343, 811, 23314, 12673, 1077, 11269, 439, 330, 849, 66917, 362, 1, 323, 1903, 264, 961, 1618, 1073, 555, 420, 5905, 13, 578, 3268, 323, 30255, 315, 279, 9875, 743, 13544, 304, 77595, 362, 4985, 18167, 279, 35508, 477, 32792, 315, 420, 42143, 9306, 11, 15851, 315, 5353, 477, 13463, 315, 279, 35508, 477, 32792, 382, 257, 2006, 468, 964, 7415, 5401, 12766, 11, 279, 9875, 617, 16070, 420, 23314, 439, 315, 279, 2457, 1176, 3485, 5439, 382, 257, 93382, 47358, 480, 87116, 11, 18610, 382, 257, 3296, 25, 611, 82, 14, 5989, 3014, 61549, 362, 13, 96024, 39649, 1078, 20308, 12, 338, 31164, 362, 13, 19497, 4910, 338, 4900, 271, 257, 5421, 11673, 5123, 984, 271, 257, 611, 82, 14, 735, 4932, 56, 8662, 964, 54, 37041, 692, 14730, 43191, 692, 65298, 27484, 20069, 271, 6794, 482, 24, 12, 262, 220, 605, 271, 33079, 63347, 29717, 12528, 271, 1408, 4154, 39, 3336, 964, 362, 271, 2611, 77956, 8825, 10734, 338, 74465, 488, 323, 11842, 12, 10464, 56875, 343, 811, 23314, 271, 257, 1115, 23314, 555, 323, 1990, 93382, 47358, 480, 87116, 18610, 2637, 264, 1561, 16228, 27767, 320, 1820, 330, 14831, 909, 323, 735, 4932, 56, 8662, 964, 54, 37041, 11, 459, 3927, 67512, 520, 220, 13121, 5034, 2418, 6583, 7301, 11, 16376, 3926, 11, 1561, 12550, 220, 17419, 1721, 320, 1820, 330, 75532, 4063, 374, 961, 315, 279, 4060, 11073, 479, 23314, 315, 279, 9875, 13, 763, 18361, 315, 323, 439, 459, 4507, 66, 1133, 369, 279, 8351, 16661, 1139, 1071, 4060, 11073, 479, 23314, 449, 4158, 14449, 1473, 257, 320, 64, 8, 4158, 14449, 56030, 323, 34008, 430, 17320, 369, 279, 7580, 315, 57515, 311, 990, 369, 477, 3318, 369, 279, 8351, 617, 304, 279, 3347, 477, 690, 87092, 279, 28957, 11, 22695, 323, 3113, 311, 4158, 14449, 315, 2038, 323, 7384, 315, 279, 8351, 430, 527, 34333, 11, 27285, 323, 6696, 6367, 11, 902, 2997, 11, 719, 527, 539, 7347, 311, 11, 19665, 7241, 8661, 6787, 11, 3495, 11, 4500, 323, 14769, 11, 6500, 3241, 11, 15670, 11, 1217, 25066, 11, 6067, 14769, 323, 9904, 11, 11618, 11, 5528, 11, 12718, 11, 10405, 11, 1440, 58523, 323, 904, 1121, 505, 279, 990, 10887, 555, 4158, 14449, 477, 279, 8351, 11, 502, 54098, 11, 77956, 8825, 320, 300, 4613, 3770, 8, 323, 18637, 311, 279, 8351, 596, 3956, 1903, 369, 477, 389, 17981, 315, 279, 8351, 320, 543, 315, 902, 11, 86599, 323, 45925, 11, 330, 15218, 82084, 257, 3161, 5363, 311, 1778, 8245, 11, 3508, 477, 539, 30929, 477, 5300, 439, 27285, 11, 34333, 477, 6696, 6367, 11, 4158, 14449, 34008, 1473, 1078, 320, 72, 8, 311, 1005, 279, 8245, 21742, 369, 279, 7580, 315, 3339, 692, 25243, 311, 477, 3318, 1234, 17517, 449, 279, 8351, 26, 323, 271, 1078, 320, 3893, 8, 539, 311, 36333, 477, 8481, 279, 8245, 311, 3885, 692, 2085, 279, 8351, 596, 5439, 8041, 382, 257, 320, 65, 8, 4158, 14449, 690, 539, 387, 32098, 505, 1701, 477, 95935, 8245, 1473, 1078, 320, 72, 8, 902, 4158, 14449, 649, 20461, 11, 555, 5439, 7576, 11, 574, 692, 3967, 311, 433, 1603, 279, 28957, 477, 3113, 315, 279, 8245, 555, 279, 692, 8351, 311, 4158, 14449, 26, 477, 271, 1078, 320, 3893, 8, 902, 374, 1457, 11, 477, 9221, 304, 279, 3938, 11, 586, 6677, 692, 1023, 1109, 555, 31471, 315, 420, 23314, 477, 279, 42143, 9306, 555, 692, 4158, 14449, 11, 1202, 8420, 477, 13307, 26, 477, 271, 1078, 320, 35694, 8, 430, 374, 2383, 3725, 12457, 555, 4158, 14449, 505, 264, 2592, 692, 9678, 315, 279, 8351, 11, 902, 2592, 574, 2383, 3725, 304, 19243, 315, 692, 279, 8245, 323, 902, 2592, 1047, 279, 78939, 1314, 311, 36333, 692, 477, 3113, 279, 8245, 311, 279, 4158, 14449, 26, 477, 271, 1078, 320, 344, 8, 430, 374, 2631, 555, 5897, 1920, 311, 387, 36489, 11, 692, 3984, 430, 4158, 14449, 690, 32100, 6179, 279, 8351, 315, 279, 692, 16686, 369, 28957, 11, 690, 11810, 279, 8351, 311, 4879, 11, 555, 692, 8475, 5897, 3445, 11, 311, 4017, 1778, 28957, 323, 690, 5196, 5244, 6794, 362, 12, 16, 271, 806, 271, 33079, 63347, 29717, 12528, 271, 257, 1005, 8475, 9045, 311, 4017, 279, 28957, 323, 10519, 692, 65295, 311, 279, 13112, 3284, 382, 257, 320, 66, 8, 578, 65295, 323, 2536, 25700, 30255, 315, 4158, 14449, 690, 7293, 304, 2515, 1306, 682, 990, 369, 279, 8351, 706, 1027, 8308, 382, 257, 320, 67, 8, 2052, 8245, 11, 2737, 904, 11236, 34366, 11, 304, 904, 3772, 11, 304, 279, 19243, 477, 2585, 315, 4158, 14449, 323, 8245, 78643, 477, 5343, 304, 904, 3241, 477, 828, 3626, 6799, 477, 9967, 389, 19002, 304, 279, 19243, 477, 2585, 315, 4158, 14449, 11, 1202, 13307, 477, 8420, 11, 4985, 387, 7108, 323, 6052, 311, 279, 8351, 5304, 7631, 11, 719, 912, 3010, 1109, 279, 9954, 315, 990, 369, 279, 8351, 382, 257, 320, 68, 8, 4158, 14449, 34008, 430, 1364, 690, 539, 3048, 279, 8245, 304, 4459, 477, 304, 961, 477, 1005, 682, 477, 904, 961, 315, 279, 8245, 311, 10134, 24490, 11, 23329, 279, 734, 11, 8668, 477, 7471, 315, 279, 8245, 369, 904, 7580, 2085, 279, 4972, 5439, 8041, 315, 279, 8351, 382, 257, 320, 69, 8, 4158, 14449, 4726, 56030, 323, 34008, 430, 682, 502, 54098, 11, 85149, 11, 18637, 11, 11618, 11, 15150, 68, 11, 14769, 11, 38940, 11, 4967, 7384, 11, 4113, 4375, 315, 3229, 5383, 11, 7397, 11, 2835, 52796, 11, 14683, 5448, 11, 9904, 11, 42134, 323, 86918, 320, 1820, 330, 50199, 59517, 8825, 4063, 430, 1253, 387, 8040, 11, 50178, 11, 477, 1903, 555, 4158, 14449, 11, 7636, 477, 53258, 449, 3885, 2391, 1077, 990, 369, 279, 8351, 11, 4985, 387, 279, 14079, 3424, 315, 279, 8351, 323, 4985, 387, 25660, 264, 990, 369, 18467, 13, 4158, 14449, 22552, 51012, 323, 34008, 311, 9993, 682, 4158, 14449, 596, 3268, 304, 904, 77956, 8825, 311, 279, 8351, 13, 4158, 14449, 22552, 25076, 311, 279, 8351, 2410, 315, 14065, 369, 279, 7580, 315, 61853, 682, 4158, 14449, 596, 3268, 304, 77956, 8825, 311, 279, 8351, 369, 279, 10096, 315, 68248, 11, 70590, 323, 1023, 16287, 1385, 25660, 5995, 555, 279, 8351, 311, 66943, 11, 6144, 11, 4832, 477, 33294, 1202, 15637, 323, 12034, 304, 77956, 8825, 13, 4158, 14449, 4726, 34008, 311, 9203, 11, 25670, 323, 6493, 904, 9904, 11, 24198, 11, 29803, 477, 75992, 5995, 311, 9993, 11, 66943, 11, 6144, 11, 4832, 477, 33294, 279, 8351, 15637, 315, 77956, 8825, 382, 257, 320, 70, 8, 4158, 14449, 56030, 323, 34008, 430, 279, 8351, 50326, 15525, 1440, 58523, 11, 34333, 11, 27285, 323, 6696, 6367, 8245, 430, 706, 1027, 13988, 3149, 477, 8040, 555, 279, 8351, 520, 2294, 20900, 323, 430, 1202, 45571, 28957, 1053, 1121, 304, 12190, 26186, 311, 279, 8351, 430, 1253, 539, 387, 49672, 66982, 555, 33384, 16337, 13, 63909, 11, 4158, 14449, 22552, 1615, 812, 311, 279, 29101, 315, 279, 12411, 323, 6406, 66563, 304, 64158, 6406, 11, 1561, 16228, 323, 34008, 430, 279, 8351, 1253, 6056, 13643, 84393, 10373, 2403, 433, 477, 1023, 24674, 16337, 5995, 311, 6144, 279, 8245, 382, 6794, 362, 12, 17, 198, 262, 16225, 25, 12838, 20207, 3424, 3549, 4194, 555, 832, 4717, 3719, 279, 3424, 315, 279, 5663, 34057, 11, 3060, 824, 279, 3878, 315, 279, 5226, 477, 5304, 279, 32659, 315, 3738, 4455, 30]
    import time
    tim = time.time()
    for i in prompt:
        ngram.preprocess_prompt([i])
    time_elapsed = time.time() - tim
    print(f"Preprocessing time: {time_elapsed:.6f} seconds")

    query = (0, 315, 2317, 311, 4320, 279)*10
    tim = time.time()
    positions = ngram.find_text_position(query)
    time_elapsed = time.time() - tim
    print(f"Query time: {time_elapsed:.6f} seconds")
    print(f"Positions of {query} in prompt: {positions}")